<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Idea Lab</title>

  <style>
    :root{
      /* THEME (brand these) */
      --bg:#0b0f14;
      --panel:#111826;
      --panel2:#0f1622;
      --ink:#e8eef8;
      --muted:#a9b6c7;
      --line:#233246;
      --accent:#7dd3fc;
      --good:#86efac;
      --warn:#fde68a;
      --bad:#fca5a5;

      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 30% -10%, rgba(125,211,252,.15), transparent 60%),
                  radial-gradient(1000px 700px at 90% 10%, rgba(134,239,172,.10), transparent 55%),
                  var(--bg);
      color:var(--ink);
    }

    header.site{
      padding:18px 18px 10px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .title{
      display:flex;
      gap:10px;
      align-items:baseline;
      flex-wrap:wrap;
    }
    h1{
      font-size:18px;
      margin:0;
      letter-spacing:.2px;
    }
    .sub{
      color:var(--muted);
      font-size:13px;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding: 10px 18px 24px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(17,24,38,.9), rgba(15,22,34,.9));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card header{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .label{
      font-size:13px;
      color:var(--muted);
    }

    .body{
      padding:14px;
      display:grid;
      gap:12px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .group{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    textarea{
      width:100%;
      min-height: 220px;
      resize: vertical;
      border:1px solid var(--line);
      background: rgba(5,10,16,.55);
      color:var(--ink);
      border-radius: 12px;
      padding:12px;
      outline:none;
      line-height:1.45;
      font-size:14px;
    }
    textarea:focus{
      border-color: rgba(125,211,252,.55);
      box-shadow: 0 0 0 3px rgba(125,211,252,.12);
    }

    button{
      border:1px solid var(--line);
      background: rgba(10,16,26,.65);
      color:var(--ink);
      padding:9px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:13px;
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
      user-select:none;
    }
    button:hover{ border-color: rgba(125,211,252,.55); }
    button:active{ transform: translateY(1px); }

    button.primary{
      border-color: rgba(125,211,252,.6);
      background: rgba(125,211,252,.12);
    }
    button.ghost{ background: transparent; }
    button.danger{
      border-color: rgba(252,165,165,.55);
      background: rgba(252,165,165,.10);
    }
    button.good{
      border-color: rgba(134,239,172,.55);
      background: rgba(134,239,172,.10);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      background: rgba(5,10,16,.35);
    }
    .tag{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(10,16,26,.35);
    }
    .muted{ color:var(--muted); font-size:12px; }

    select, input[type="range"]{ accent-color: var(--accent); }
    select{
      border:1px solid var(--line);
      background: rgba(5,10,16,.35);
      color:var(--ink);
      padding:7px 8px;
      border-radius: 12px;
      font-size:13px;
      outline:none;
    }

    .constraints{
      display:grid;
      gap:10px;
      padding:12px;
      border:1px dashed rgba(35,50,70,.9);
      border-radius: 14px;
      background: rgba(5,10,16,.25);
    }
    .constraints .c-row{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px;
      align-items:center;
    }
    .constraints label{
      font-size:12px;
      color:var(--muted);
    }

    .surface{
      padding:12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(5,10,16,.35);
      min-height: 220px;
      line-height:1.45;
      font-size:14px;
      white-space: pre-wrap;
    }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      .split{ grid-template-columns: 1fr; }
    }

    .list{ display:grid; gap:10px; }

    .item{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px;
      background: rgba(5,10,16,.35);
      display:grid;
      gap:8px;
    }
    .item .top{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .item .snippet{
      color: var(--ink);
      font-size:13px;
      line-height:1.35;
      opacity:.95;
      max-height: 3.9em;
      overflow:hidden;
      white-space: pre-wrap;
    }
    .item .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(5,10,16,.35);
      color: var(--muted);
    }

    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(15,22,34,.92);
      box-shadow: var(--shadow);
      color: var(--ink);
      font-size: 13px;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .2s ease, transform .2s ease;
      pointer-events:none;
      max-width: 420px;
      white-space: pre-wrap;
    }
    .toast.show{
      opacity: 1;
      transform: translateY(0);
    }

    .qblock{
      display:grid;
      gap:8px;
      margin-bottom:14px;
      padding-bottom:12px;
      border-bottom:1px dashed rgba(35,50,70,.9);
    }
    .qblock:last-child{ border-bottom:none; padding-bottom:0; }
    .qtitle{ font-size:12px; color:var(--muted); }
    .qtextarea{ min-height: 80px; }
  </style>
</head>

<body>
  <header class="site">
    <div class="title">
      <h1>Idea Lab</h1>
      <div class="sub">A small studio for shaping ideas into selectable drafts. Local-only autosave. ðŸ§ª</div>
    </div>
  </header>

  <main class="wrap">
    <section class="card" aria-label="Idea Input">
      <header>
        <div class="label">1) Seed</div>
        <div class="group">
          <span class="pill">Undo <span class="kbd">Ctrl</span>+<span class="kbd">Z</span></span>
          <span class="pill">Redo <span class="kbd">Ctrl</span>+<span class="kbd">Y</span></span>
        </div>
      </header>

      <div class="body">
        <div class="muted">
          Write a rough idea. The tool helps you iterate without outsourcing your thinking.
        </div>

        <textarea id="seed" placeholder="Drop your messy idea here..."></textarea>

        <div class="constraints" aria-label="Constraints">
          <div class="row">
            <div class="label">2) Constraints</div>
            <div class="muted">These shape transforms and questions.</div>
          </div>

          <div class="c-row">
            <label for="tone">Tone</label>
            <select id="tone">
              <option value="plain">Plainspoken</option>
              <option value="warm">Warm</option>
              <option value="bold">Bold</option>
              <option value="playful">Playful</option>
              <option value="formal">Formal</option>
            </select>
          </div>

          <div class="c-row">
            <label for="audience">Audience</label>
            <select id="audience">
              <option value="general">General</option>
              <option value="teammate">Teammate</option>
              <option value="client">Client</option>
              <option value="funder">Funder</option>
              <option value="expert">Expert</option>
            </select>
          </div>

          <div class="c-row">
            <label for="length">Length</label>
            <div class="group" style="width:100%;">
              <input id="length" type="range" min="0" max="100" value="40" style="width:100%;" />
              <span id="lengthLabel" class="tag" aria-live="polite">~ medium</span>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="group">
            <button class="primary" id="btnClarify">Clarify</button>
            <button id="btnCompress">Compress</button>
            <button id="btnExpand">Expand with detail</button>
            <button id="btnQuestions" class="ghost">Reflection questions</button>
          </div>
          <div class="group">
            <button id="btnCommit" class="good">Commit to history</button>
            <button id="btnReset" class="danger">Reset</button>
          </div>
        </div>

        <div class="row">
          <div class="muted" id="status">Autosave: on</div>
          <div class="muted">Local: <span class="kbd">localStorage</span> only</div>
        </div>
      </div>
    </section>

    <section class="card" aria-label="Output & Versions">
      <header>
        <div class="label">3) Studio surface</div>
        <div class="group">
          <button id="btnPin" class="ghost">Pin current</button>
          <button id="btnCopy" class="ghost">Copy</button>
          <button id="btnExport" class="primary">Export bundle</button>
        </div>
      </header>

      <div class="body">
        <div class="row">
          <div class="pill" id="modePill">Mode: Draft</div>
          <div class="muted" id="draftMeta">No transform yet.</div>
        </div>

        <div id="surface" class="surface" role="region" aria-label="Studio surface"></div>

        <div class="constraints" aria-label="Iteration note">
          <div class="row">
            <div class="label">Iteration note</div>
            <div class="muted">Optional: why this version works.</div>
          </div>
          <textarea id="note" class="qtextarea" placeholder="e.g., This draft clarifies the outcome and names a concrete test."></textarea>
          <div class="row">
            <div class="muted">Notes are saved with commits and pins.</div>
            <button id="btnAttachNote" class="ghost">Attach note to current</button>
          </div>
        </div>

        <div class="split">
          <div>
            <div class="row">
              <div class="pill">History</div>
              <div class="muted">Load any version.</div>
            </div>
            <div id="historyList" class="list" aria-label="History versions"></div>
          </div>
          <div>
            <div class="row">
              <div class="pill">Pins</div>
              <div class="muted">Keepers.</div>
            </div>
            <div id="pinList" class="list" aria-label="Pinned versions"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" aria-live="polite"></div>

  <script>
    const LS_KEY = "idea_lab_v2_state";
    const nowISO = () => new Date().toISOString();
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    const el = {
      seed: document.getElementById("seed"),
      tone: document.getElementById("tone"),
      audience: document.getElementById("audience"),
      length: document.getElementById("length"),
      lengthLabel: document.getElementById("lengthLabel"),
      status: document.getElementById("status"),

      surface: document.getElementById("surface"),
      modePill: document.getElementById("modePill"),
      draftMeta: document.getElementById("draftMeta"),

      note: document.getElementById("note"),
      btnAttachNote: document.getElementById("btnAttachNote"),

      historyList: document.getElementById("historyList"),
      pinList: document.getElementById("pinList"),

      btnClarify: document.getElementById("btnClarify"),
      btnCompress: document.getElementById("btnCompress"),
      btnExpand: document.getElementById("btnExpand"),
      btnQuestions: document.getElementById("btnQuestions"),
      btnCommit: document.getElementById("btnCommit"),
      btnReset: document.getElementById("btnReset"),

      btnPin: document.getElementById("btnPin"),
      btnCopy: document.getElementById("btnCopy"),
      btnExport: document.getElementById("btnExport"),

      toast: document.getElementById("toast"),
    };

    function safeUUID(){
      try { return crypto.randomUUID(); } catch { return String(Math.random()).slice(2); }
    }

    function toast(msg){
      el.toast.textContent = msg;
      el.toast.classList.add("show");
      window.clearTimeout(toast._t);
      toast._t = window.setTimeout(()=> el.toast.classList.remove("show"), 1900);
    }

    function sanitizeSeed(txt){
      return (txt || "").trim().replace(/\s+\n/g, "\n").replace(/[ \t]+/g, " ");
    }

    function lengthBucket(v){
      if (v < 25) return { label: "~ short", words: 35 };
      if (v < 55) return { label: "~ medium", words: 70 };
      return { label: "~ long", words: 120 };
    }

    function compressToWords(text, maxWords){
      const words = String(text).split(/\s+/).filter(Boolean);
      if (words.length <= maxWords) return text;
      return words.slice(0, maxWords).join(" ") + "â€¦";
    }

    function applyTonePrefix(tone){
      switch(tone){
        case "warm": return "Warm lens: ";
        case "bold": return "Bold claim: ";
        case "playful": return "Playful angle: ";
        case "formal": return "Formal framing: ";
        default: return "";
      }
    }

    function applyAudienceHint(aud){
      switch(aud){
        case "teammate": return "For a teammate: ";
        case "client": return "For a client: ";
        case "funder": return "For a funder: ";
        case "expert": return "For an expert: ";
        default: return "";
      }
    }

    function escapeHTML(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    const state = {
      seed: "",
      constraints: { tone:"plain", audience:"general", length:40 },
      current: {
        mode: "draft",
        kind: "",
        text: "",
        questions: [],
        answers: {},
        note: "",
        createdAt: null,
        constraints: null,
      },
      history: [],
      pins: [],
      undo: [],
      redo: [],
    };

    function snapshot(){
      return JSON.parse(JSON.stringify({
        seed: state.seed,
        constraints: state.constraints,
        current: state.current,
        history: state.history,
        pins: state.pins
      }));
    }

    function pushUndo(){
      state.undo.push(snapshot());
      state.redo = [];
      if (state.undo.length > 60) state.undo.shift();
    }

    function restore(snap){
      state.seed = snap.seed || "";
      state.constraints = snap.constraints || { tone:"plain", audience:"general", length:40 };
      state.current = snap.current || {
        mode:"draft", kind:"", text:"", questions:[], answers:{}, note:"", createdAt:null, constraints:null
      };
      state.history = snap.history || [];
      state.pins = snap.pins || [];
      syncUI();
    }

    function save(){
      try{
        localStorage.setItem(LS_KEY, JSON.stringify(snapshot()));
        el.status.textContent = "Autosave: saved";
        window.clearTimeout(save._t);
        save._t = window.setTimeout(()=> el.status.textContent = "Autosave: on", 900);
      }catch{
        el.status.textContent = "Autosave: unavailable";
      }
    }

    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        restore(JSON.parse(raw));
        toast("Loaded previous session");
      }catch{}
    }

    function t_clarify(seed, c){
      const prefix = applyAudienceHint(c.audience) + applyTonePrefix(c.tone);
      const core = seed.replace(/\.$/, "");
      const why = c.audience === "funder"
        ? "This matters because it strengthens outcomes and reduces waste."
        : "This matters because it helps people decide and act with more confidence.";
      const next = "Next step: pick one concrete test you can run this week.";
      const draft = `${prefix}${core}.\n\nWhy it matters: ${why}\n${next}`;
      return compressToWords(draft, lengthBucket(c.length).words);
    }

    function t_compress(seed, c){
      const prefix = applyAudienceHint(c.audience);
      const parts = seed.split(/(?<=[.!?])\s+/).filter(Boolean);
      const base = parts.slice(0, Math.min(2, parts.length)).join(" ");
      const soWhat = c.audience === "expert"
        ? "Key point: define the mechanism and test the boundary conditions."
        : "Key point: name the outcome and the smallest experiment.";
      const draft = `${prefix}${base}\n\n${soWhat}`;
      return compressToWords(draft, clamp(lengthBucket(c.length).words - 15, 20, 90));
    }

    function t_expand(seed, c){
      const prefix = applyTonePrefix(c.tone);
      const prompts = [
        "Whatâ€™s the specific context or setting?",
        "Whatâ€™s the constraint (time, budget, attention, risk)?",
        "Whatâ€™s one example that makes this real?",
        "What would success look like in one sentence?"
      ];
      const audienceAdd = c.audience === "funder"
        ? "Add: Who benefits, and what changes will be measurable?"
        : c.audience === "client"
          ? "Add: What decision will this help you make?"
          : "Add: Whatâ€™s the smallest prototype you can build?";

      const draft =
`${prefix}${seed}

Details to add (fill these in):
- Context: â€¦
- Constraint: â€¦
- Example: â€¦
- Success statement: â€¦

Guiding questions:
- ${prompts.join("\n- ")}

${audienceAdd}`;

      return compressToWords(draft, clamp(lengthBucket(c.length).words + 30, 60, 180));
    }

    function t_reflectionQuestions(c){
      const qs = [
        "What are you trying to change, for whom, and by when?",
        "Whatâ€™s the smallest version of this that still teaches you something?",
        "What assumption would embarrass you if it turned out false?",
        "What would you remove to make this clearer in 10 seconds?"
      ];
      if (c.audience === "funder"){
        qs.unshift("What outcome are you accountable for, and how will you know it moved?");
      }
      return qs;
    }

    function answersToDraft(seed, c, questions, answersObj){
      const answered = questions
        .map((q, i) => ({ q, a: (answersObj[i] || "").trim() }))
        .filter(x => x.a.length > 0);

      const prefix = applyAudienceHint(c.audience) + applyTonePrefix(c.tone);
      const intro = seed ? `${prefix}${seed.replace(/\.$/,"")}.` : `${prefix}Draft based on reflection answers.`;
      const body = answered.map(x => `- ${x.a}`).join("\n");
      const closing = c.audience === "funder"
        ? "\n\nProposed test: Identify one indicator, one data source, and one timeline."
        : "\n\nProposed test: Name one small prototype and one feedback loop.";

      const draft = `${intro}\n\nKey notes:\n${body}${closing}`;
      return compressToWords(draft, lengthBucket(c.length).words + 40);
    }

    function getConstraints(){
      return {
        tone: el.tone.value,
        audience: el.audience.value,
        length: Number(el.length.value)
      };
    }

    function setCurrentDraft(kind, text){
      state.current = {
        mode: "draft",
        kind,
        text: String(text || ""),
        questions: [],
        answers: state.current.answers || {},
        note: state.current.note || "",
        createdAt: nowISO(),
        constraints: JSON.parse(JSON.stringify(state.constraints))
      };
    }

    function setCurrentReflection(){
      state.current = {
        mode: "reflection",
        kind: "reflection",
        text: "",
        questions: t_reflectionQuestions(state.constraints),
        answers: state.current.answers || {},
        note: state.current.note || "",
        createdAt: nowISO(),
        constraints: JSON.parse(JSON.stringify(state.constraints))
      };
    }

    function renderSurface(){
      const c = state.current;
      el.modePill.textContent = c.mode === "reflection" ? "Mode: Reflection" : "Mode: Draft";
      el.draftMeta.textContent = c.createdAt
        ? `${c.kind || c.mode} â€¢ ${new Date(c.createdAt).toLocaleString()}`
        : "No transform yet.";

      el.note.value = c.note || "";

      if (c.mode === "reflection"){
        const blocks = c.questions.map((q, i) => {
          const a = (c.answers && c.answers[i]) ? c.answers[i] : "";
          return `
            <div class="qblock">
              <div class="qtitle">${q}</div>
              <textarea class="qtextarea" data-qindex="${i}" placeholder="Your responseâ€¦">${escapeHTML(a)}</textarea>
            </div>
          `;
        }).join("");

        el.surface.innerHTML = `
          <div class="muted" style="margin-bottom:10px;">
            Answer any 1â€“3 questions. Then turn your answers into a draft you can refine.
          </div>
          ${blocks}
          <div class="row" style="margin-top:10px;">
            <div class="group">
              <button id="btnAnswersToDraft" class="primary">Turn answers into a draft</button>
              <button id="btnBackToDraft" class="ghost">Back to draft view</button>
            </div>
            <div class="muted">Nothing is sent anywhere. This stays in your browser.</div>
          </div>
        `;
      } else {
        el.surface.textContent = c.text || "Run a transform (Clarify / Compress / Expand) or enter Reflection mode.";
      }
    }

    function renderList(listEl, items, kind){
      listEl.innerHTML = "";
      if (!items.length){
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.textContent = kind === "pins" ? "No pins yet. Pin a keeper draft." : "No committed versions yet.";
        listEl.appendChild(empty);
        return;
      }

      items.slice().reverse().forEach((v) => {
        const card = document.createElement("div");
        card.className = "item";

        const top = document.createElement("div");
        top.className = "top";

        const left = document.createElement("div");
        left.className = "group";

        const tag1 = document.createElement("span");
        tag1.className = "tag";
        tag1.textContent = `${v.kind || "version"} â€¢ ${new Date(v.createdAt).toLocaleString()}`;

        const tag2 = document.createElement("span");
        tag2.className = "tag";
        tag2.textContent = `${v.constraints.tone}/${v.constraints.audience}/${lengthBucket(v.constraints.length).label.replace("~ ","")}`;

        left.appendChild(tag1);
        left.appendChild(tag2);

        const actions = document.createElement("div");
        actions.className = "actions";

        const btnLoad = document.createElement("button");
        btnLoad.textContent = "Load";
        btnLoad.className = "ghost";
        btnLoad.addEventListener("click", () => {
          pushUndo();
          state.current = {
            mode: "draft",
            kind: v.kind,
            text: v.text,
            questions: [],
            answers: state.current.answers || {},
            note: v.note || "",
            createdAt: nowISO(),
            constraints: JSON.parse(JSON.stringify(v.constraints))
          };
          state.constraints = JSON.parse(JSON.stringify(v.constraints));
          syncUI();
          save();
          toast("Loaded into current draft");
        });

        const btnCopy = document.createElement("button");
        btnCopy.textContent = "Copy";
        btnCopy.className = "ghost";
        btnCopy.addEventListener("click", async () => {
          await navigator.clipboard.writeText(v.text);
          toast("Copied");
        });

        const btnDelete = document.createElement("button");
        btnDelete.textContent = "Delete";
        btnDelete.className = "danger";
        btnDelete.addEventListener("click", () => {
          pushUndo();
          const arr = kind === "pins" ? state.pins : state.history;
          const idx = arr.findIndex(x => x.id === v.id);
          if (idx >= 0) arr.splice(idx, 1);
          syncUI();
          save();
          toast("Deleted");
        });

        actions.appendChild(btnLoad);
        actions.appendChild(btnCopy);
        actions.appendChild(btnDelete);

        top.appendChild(left);
        top.appendChild(actions);

        const snippet = document.createElement("div");
        snippet.className = "snippet";
        snippet.textContent = v.text;

        card.appendChild(top);
        card.appendChild(snippet);

        if (v.note){
          const note = document.createElement("div");
          note.className = "muted";
          note.textContent = `Note: ${v.note}`;
          card.appendChild(note);
        }

        listEl.appendChild(card);
      });
    }

    function syncUI(){
      el.seed.value = state.seed;
      el.tone.value = state.constraints.tone;
      el.audience.value = state.constraints.audience;
      el.length.value = state.constraints.length;
      el.lengthLabel.textContent = lengthBucket(state.constraints.length).label;

      renderSurface();
      renderList(el.historyList, state.history, "history");
      renderList(el.pinList, state.pins, "pins");
    }

    function ensureSeed(){
      const seed = sanitizeSeed(el.seed.value);
      state.seed = seed;
      if (!seed){
        toast("Add a seed idea first");
        return false;
      }
      return true;
    }

    function doDraftTransform(kind){
      if (!ensureSeed()) return;
      state.constraints = getConstraints();

      const seed = state.seed;
      const c = state.constraints;

      let out = "";
      if (kind === "clarify") out = t_clarify(seed, c);
      if (kind === "compress") out = t_compress(seed, c);
      if (kind === "expand") out = t_expand(seed, c);

      pushUndo();
      setCurrentDraft(kind, out);
      syncUI();
      save();
      toast("Draft updated");
    }

    function enterReflection(){
      if (!ensureSeed()) return;
      state.constraints = getConstraints();
      pushUndo();
      setCurrentReflection();
      syncUI();
      save();
      toast("Reflection mode");
    }

    function collectReflectionAnswers(){
      const answers = {};
      const nodes = el.surface.querySelectorAll("textarea[data-qindex]");
      nodes.forEach(n => { answers[n.dataset.qindex] = n.value; });
      state.current.answers = answers;
    }

    function reflectionToDraft(){
      if (!ensureSeed()) return;

      state.constraints = getConstraints();
      collectReflectionAnswers();

      const ans = state.current.answers || {};
      const anyAnswered = Object.values(ans).some(v => String(v).trim().length > 0);
      if (!anyAnswered){
        toast("Answer at least one question");
        return;
      }

      const draft = answersToDraft(state.seed, state.constraints, state.current.questions || [], ans);

      pushUndo();
      setCurrentDraft("draft-from-reflection", draft);
      syncUI();
      save();
      toast("Draft created from answers");
    }

    function commitVersion(){
      if (state.current.mode !== "draft" || !state.current.text){
        toast("Commit works on a draft. Create or load a draft first.");
        return;
      }
      pushUndo();
      state.history.push({
        id: safeUUID(),
        kind: state.current.kind || "draft",
        text: state.current.text,
        note: state.current.note || "",
        createdAt: nowISO(),
        constraints: JSON.parse(JSON.stringify(state.constraints))
      });
      syncUI();
      save();
      toast("Committed to history");
    }

    function pinCurrent(){
      if (state.current.mode !== "draft" || !state.current.text){
        toast("Pin works on a draft. Create or load a draft first.");
        return;
      }
      pushUndo();
      const exists = state.pins.some(p => p.text === state.current.text);
      if (!exists){
        state.pins.push({
          id: safeUUID(),
          kind: "pin",
          text: state.current.text,
          note: state.current.note || "",
          createdAt: nowISO(),
          constraints: JSON.parse(JSON.stringify(state.constraints))
        });
        toast("Pinned");
      } else {
        toast("Already pinned");
      }
      syncUI();
      save();
    }

    async function copyCurrent(){
      if (state.current.mode !== "draft" || !state.current.text){
        toast("Nothing to copy");
        return;
      }
      await navigator.clipboard.writeText(state.current.text);
      toast("Copied");
    }

    async function exportBundle(){
      const bundle = {
        exportedAt: nowISO(),
        seed: state.seed,
        constraints: state.constraints,
        current: state.current,
        history: state.history,
        pins: state.pins
      };

      const text =
`IDEA LAB EXPORT
Exported: ${bundle.exportedAt}

SEED
${bundle.seed}

CONSTRAINTS
- Tone: ${bundle.constraints.tone}
- Audience: ${bundle.constraints.audience}
- Length: ${lengthBucket(bundle.constraints.length).label}

CURRENT
- Mode: ${bundle.current.mode}
- Kind: ${bundle.current.kind}
- Note: ${bundle.current.note || "(none)"}

DRAFT TEXT
${bundle.current.text || "(none)"}

REFLECTION (if any)
${(bundle.current.questions || []).map((q,i)=>`Q${i+1}: ${q}\nA: ${(bundle.current.answers && bundle.current.answers[i]) ? bundle.current.answers[i] : ""}\n`).join("\n")}

HISTORY (${bundle.history.length})
${bundle.history.map((v,i)=>`[${i+1}] ${v.kind} â€¢ ${new Date(v.createdAt).toLocaleString()}\nNote: ${v.note || "(none)"}\n${v.text}\n`).join("\n")}

PINS (${bundle.pins.length})
${bundle.pins.map((v,i)=>`[${i+1}] â€¢ ${new Date(v.createdAt).toLocaleString()}\nNote: ${v.note || "(none)"}\n${v.text}\n`).join("\n")}
`;
      await navigator.clipboard.writeText(text);
      toast("Export copied to clipboard");
    }

    function attachNote(){
      pushUndo();
      state.current.note = (el.note.value || "").trim();
      syncUI();
      save();
      toast("Note attached to current");
    }

    function resetAll(){
      pushUndo();
      state.seed = "";
      state.constraints = { tone:"plain", audience:"general", length:40 };
      state.current = { mode:"draft", kind:"", text:"", questions:[], answers:{}, note:"", createdAt:null, constraints:null };
      state.history = [];
      state.pins = [];
      syncUI();
      save();
      toast("Reset complete");
    }

    // Wiring
    el.seed.addEventListener("input", () => { state.seed = sanitizeSeed(el.seed.value); save(); });
    el.tone.addEventListener("change", () => { state.constraints = getConstraints(); syncUI(); save(); });
    el.audience.addEventListener("change", () => { state.constraints = getConstraints(); syncUI(); save(); });
    el.length.addEventListener("input", () => { state.constraints = getConstraints(); syncUI(); save(); });

    el.btnClarify.addEventListener("click", () => doDraftTransform("clarify"));
    el.btnCompress.addEventListener("click", () => doDraftTransform("compress"));
    el.btnExpand.addEventListener("click", () => doDraftTransform("expand"));
    el.btnQuestions.addEventListener("click", () => enterReflection());

    el.btnCommit.addEventListener("click", () => commitVersion());
    el.btnReset.addEventListener("click", () => resetAll());

    el.btnPin.addEventListener("click", () => pinCurrent());
    el.btnCopy.addEventListener("click", () => copyCurrent());
    el.btnExport.addEventListener("click", () => exportBundle());
    el.btnAttachNote.addEventListener("click", () => attachNote());

    document.addEventListener("click", (e) => {
      if (e.target && e.target.id === "btnAnswersToDraft"){
        reflectionToDraft();
      }
      if (e.target && e.target.id === "btnBackToDraft"){
        pushUndo();
        state.current.mode = "draft";
        syncUI();
        save();
        toast("Draft view");
      }
    });

    document.addEventListener("input", (e) => {
      if (e.target && e.target.matches("textarea[data-qindex]")){
        const idx = e.target.dataset.qindex;
        state.current.answers = state.current.answers || {};
        state.current.answers[idx] = e.target.value;
        save();
      }
    });

    document.addEventListener("keydown", (e) => {
      const isMac = navigator.platform.toUpperCase().includes("MAC");
      const mod = isMac ? e.metaKey : e.ctrlKey;
      if (!mod) return;

      if (e.key.toLowerCase() === "z" && !e.shiftKey){
        e.preventDefault();
        const snap = state.undo.pop();
        if (snap){
          state.redo.push(snapshot());
          restore(snap);
          save();
          toast("Undo");
        }
      } else if (e.key.toLowerCase() === "y" || (e.key.toLowerCase() === "z" && e.shiftKey)){
        e.preventDefault();
        const snap = state.redo.pop();
        if (snap){
          state.undo.push(snapshot());
          restore(snap);
          save();
          toast("Redo");
        }
      }
    });

    // Boot
    load();
    syncUI();
  </script>
</body>
</html>
